# Stage 1: Build environment
FROM python:3.10-alpine3.17 AS builder

RUN apk add --no-cache mariadb-dev build-base pkgconfig

# Set the working directory in the container
WORKDIR /app

# Install dependencies
COPY /backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the Django project files to the container
COPY ./backend/ .

# Copy the frontend static files to the container
COPY ./frontend/build/ /app/frontend/build/

# Copy the dockerize binary into the container
COPY ./backend/utils/dockerize/dockerize /usr/local/bin/dockerize

# Make the dockerize binary executable
RUN chmod +x /usr/local/bin/dockerize

# Stage 2: Runtime environment
FROM python:3.10-alpine3.17

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Copy the installed dependencies from the builder stage
COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages

# Set the working directory in the container
WORKDIR /app

# Copy the Django project files to the container
COPY --from=builder /app .

# Copy the frontend static files to the container
COPY --from=builder /app/frontend/build/ /app/frontend/build/

# Copy the dockerize binary into the container
COPY --from=builder /usr/local/bin/dockerize /usr/local/bin/dockerize

# Expose the default Django development server port
EXPOSE 8000

# Run the Django development server
CMD dockerize -wait tcp://db:3306 -timeout 60s && python manage.py makemigrations --settings=betterAirbnb.prod_settings && python manage.py migrate --settings=betterAirbnb.prod_settings && python manage.py runserver 0.0.0.0:8000 --settings=betterAirbnb.prod_settings

